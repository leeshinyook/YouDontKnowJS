# 지금과 나중

> 지금과 나중사이의 `간극` 에 관한 문제다.
>
> 프로그램에서의 `지금` 과 `나중` 에 해당하는 부분 사이의 관계가 비동기 프로그램의 핵심이다.



### 비동기

- 단위 : 함수
- 지금 당장 끝낼 수 없는 작업(`DB조회, 네트워크를 경유한 데이터 송신 후 응답대기`)등 은 비동기적으로 처리된다.
  - 즉, 중단하지 않는다. Non-Blocking!

> 예를 들어, 데이터를 서버에서 조회하고 싶을 때, AJAX 네트워크 요청을 한다면, 브라우저는 네트워크를 통해
>
> 열심히 응답을 리스닝한다. 뭔가 사용자에게 줄 데이터가 도착하면, 콜백 함수(응답 처리 코드 = 콜백)를 이벤트 루프에
>
> 삽입하여, 실행 스케줄링을 한다.

> 많은 프로그램에서 I/O 부분이 가장 느리고 중단이 잦다. 
>
> 왜? I/O를 백그라운드에서 비동기적으로 처리해야 성능상 유리하다.



### 이벤트 루프

> 자바스크립트 엔진은 요청하면 프로그램을 주어진 시점에 한 덩이씩 묵묵히 실행할 뿐.

- 엔진 환경 : 호스팅(웹브라우저) 에서 다른환경(Node.js)로 그 영역을 확장하는 중.

- 프로그램 덩이를 시간에 따라 매 순간 한 번씩 엔진을 실행시키는 `이벤트 루프` 라는 장치가 있다.

```javascript
// 'eventLoop' 는 규 역할을 하는 배열이다.
var eventLoop = [];
var event;

// 무한실행
while(true) {
  // '틱'발생
  if(eventLoop.length > 0) {
    // 큐에 있는 다음 이벤트를 조회한다.
    event = eventLoop.shift();
    // 이제 다음 이벤트를 실행한다.
    try {
      event()
    } catch(err) {
      reportError(err);
    }
  }
}
```

- 적재된 이벤트를 꺼내어 실행한다.
- 매 순회(Iteration)을 `틱(Tick)` 이라고 한다.
- `setTimeout()` 은 콜백을 이벤트 루프 큐에 넣지 않는다.
  - 타이머를 설정하는 함수다. 타이머가 끝나면 환경이 콜백을 이벤트 루프에 삽입한 뒤 틱에서 콜백을 꺼내어 실행

> ES6부터는, 이벤트 루프 큐 관리방식의 변화가 있었다. 작동 방식이 정확히 규정되어
>
> 이제야 호스팅(브라우저) 환경이 아닌 자바스크립트 엔진의 관할이 됐다. 



### 병렬 스레딩

> 병렬과 비동기는 의미가 완전히 다르다!
>
> 비동기 = 간극
>
> 병렬 = 동시에 일어나는 일

- 이벤트 루프는 작업 단위로 나누어 차례대로 실행되지만, 공유 메모리에 병렬로 접근하거나 변경할 수 없다.
  - 반면에, 병렬은 접근.
- 병렬 스레딩에서는 `인터리빙` (동시에 메모리를 여러 곳에서 접근) 문제가 발생할 수 도 있다.



### 동시성

> 이벤트 루프 큐에서 이벤트들은 어떻게 인터리빙 될까?
>
> > 이벤트 루프 큐에서 차례대로 실행된다.

- 프로세스 사이에 연관된 작업이 없다면, 프로세스 간 상호작용은 의미가 없다.

- 복수의 프로세스가 같은 시간 동안에 동시에 실행됨을 의미하며, 각 프로세스 작업들이 병렬로 처리되는지와는 관계없다.
  - 병행성(개별 프로세서의 스레드)





### 잡큐(Job Queue)

> 이벤트 루프 큐에서 매 틱의 끝자락에 매달려 있는 큐!

```javascript
console.log('a');

setTimeout(function() {
  console.log('b');
},0);

// 이론적 잡API
schedule(function() {
  console.log('c');
  
  schedule(function() {
    console.log('d');
  })
})

// a c d b
```



### 문 순서

> 자바스크립트 엔진은 반드시 프로그램에 표현된 문의 순서대로 실행하지 않는다. 

- 자바스크립트 엔진은 어떻게 할까?
  - 코드를 컴파일후, 문 순서를 (안전하게) 재정렬하면서 실행 시간을 줄일 여지를 확인한다.
  - 최종 결과가 뒤바뀌지 않도록 안전하게 최적화를 진행한다.
- 예외
  - 부수효과가 있는 함수 호출인 경우(`Getter Function`) 순서를 조정하지 않는다. => 성능저하



### 정리

- 언제나 한 번에 정확히 한 개의 이벤트만 큐에서 꺼내 처리한다. 
- 동시성은 복수의 이벤트들이 연쇄적으로 시간에 따라 인터리빙 되면서 고수준의 관점에서 보면은 꼭 동시에 실행되는 것처럼 보임
  - 실제로는 특정 시점에 1개 이벤트만 처리되고 있다.

